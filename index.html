<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>前方後円墳で来た。</title>
<style>
  body { margin:0; overflow:hidden; touch-action:none; background:#87ceeb; font-family:sans-serif; }
  canvas { display:block; margin:auto; background:#87ceeb; }
  #restartBtn {
    position:absolute; display:none; left:50%; top:60%; transform:translate(-50%,-50%);
    padding:10px 20px; font-size:20px; cursor:pointer;
  }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<button id="restartBtn">Restart</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

// --- Firebase設定 ---
const firebaseConfig = {
  apiKey: "AIzaSyBMJWHa5H0COcPcFO5-SJV3jaIm1y9lggY",
  authDomain: "zenpo-ko-enfun.firebaseapp.com",
  databaseURL: "https://zenpo-ko-enfun-default-rtdb.firebaseio.com",
  projectId: "zenpo-ko-enfun",
  storageBucket: "zenpo-ko-enfun.firebasestorage.app",
  messagingSenderId: "824547703470",
  appId: "1:824547703470:web:b9c36e1554a50de544cb3f",
  measurementId: "G-JWX8H2C58G"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- 今日の世界記録 ---
function getTodayKey() {
  const now = new Date();
  return `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
}
async function getTodayRecord() {
  const snapshot = await get(ref(db, 'worldRecords/' + getTodayKey()));
  return snapshot.exists() ? snapshot.val() : 0;
}
async function updateTodayRecord(score) {
  const key = getTodayKey();
  const oldScore = await getTodayRecord();
  if(score > oldScore){
    await set(ref(db, 'worldRecords/' + key), score);
    return true;
  }
  return false;
}

// --- ゲーム用 ---
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const restartBtn = document.getElementById("restartBtn");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
let tileSize = Math.min(canvas.width/7, canvas.height/12);

// 画像
const seaImg = new Image(); seaImg.src = "sea_tile.png";
const islandImg = new Image(); islandImg.src = "island.png";
const kofunImg = new Image(); kofunImg.src = "kofun.png";
const coinImg = new Image(); coinImg.src = "coin.png";
const magatamaImg = new Image(); magatamaImg.src = "magatama.png"; // 勾玉

// --- 初期化 ---
let seaTiles = [];
for(let y=-1;y<=12;y++) for(let x=0;x<7;x++) seaTiles.push({x,y});
let offsetY=0;
const baseSpeed=16;
const scrollSpeed = baseSpeed*(tileSize/64);

let kofun={ x:canvas.width/2, y:canvas.height-tileSize*1.5, size:tileSize };
let mouse={x:kofun.x, y:kofun.y};

let islands=[], coins=[], magatamas=[], score=0, gameOver=false;

// --- 燃料 ---
let maxFuel = 100;
let fuel = maxFuel;
const fuelConsumption = 0.1;

// --- 入力 ---
canvas.addEventListener("mousemove", e=>{ mouse.x=e.offsetX - kofun.size/2; mouse.y=e.offsetY - kofun.size/2; });
canvas.addEventListener("touchmove", e=>{ mouse.x=e.touches[0].clientX - kofun.size/2; mouse.y=e.touches[0].clientY - kofun.size/2; });

// --- 島・コイン・勾玉 ---
function spawnIsland(){ islands.push({x:Math.random()*(canvas.width-tileSize*2), y:-tileSize*2, size:tileSize*2}); }
setInterval(spawnIsland,2000);

function spawnCoin(){
  let coin, overlap;
  do{
    coin={x:Math.random()*(canvas.width-tileSize/2), y:-tileSize/2, size:tileSize/2};
    overlap=islands.some(island=>!(coin.x+coin.size<island.x||coin.x>island.x+island.size||coin.y+coin.size<island.y||coin.y>island.y+island.size));
  }while(overlap);
  coins.push(coin);
}
setInterval(spawnCoin,1500);

function spawnMagatama(){
  magatamas.push({ 
    x: Math.random()*(canvas.width - tileSize*0.8), 
    y: -tileSize*0.8, 
    size: tileSize*1
  });
}
setInterval(spawnMagatama,10000);

// --- 衝突判定 ---
function isColliding(a,b){ return !(a.x+a.size<b.x||a.x>b.x+b.size||a.y+a.size<b.y||a.y>b.y+b.size); }

// --- ゲームループ ---
let loopId;
function gameLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // 海
  for(let t of seaTiles) ctx.drawImage(seaImg,t.x*tileSize,t.y*tileSize+offsetY,tileSize,tileSize);
  offsetY += scrollSpeed; if(offsetY>=tileSize) offsetY=0;

  // 島
for(let i=islands.length-1;i>=0;i--){
    let island = islands[i];
    island.y += scrollSpeed;
    ctx.drawImage(islandImg, island.x, island.y, island.size, island.size);

    // 小さめの矩形で衝突判定
    const margin = 0.6; // 判定サイズを60%に
    const hitBox = {
        x: island.x + island.size * (1 - margin) / 2,
        y: island.y + island.size * (1 - margin) / 2,
        size: island.size * margin
    };
    if(isColliding(kofun, hitBox)) gameOver = true;

    if(island.y > canvas.height) islands.splice(i,1);
}


  // コイン
  for(let i=coins.length-1;i>=0;i--){
    let coin=coins[i];
    coin.y+=scrollSpeed;
    ctx.drawImage(coinImg,coin.x,coin.y,coin.size,coin.size);
    if(isColliding(kofun,coin)){ score+=10; coins.splice(i,1); }
    else if(coin.y>canvas.height) coins.splice(i,1);
  }

  // 勾玉
  for(let i=magatamas.length-1;i>=0;i--){
    let m = magatamas[i];
    m.y += scrollSpeed;
    ctx.drawImage(magatamaImg, m.x, m.y, m.size, m.size);
    if(isColliding(kofun, m)){
      fuel = Math.min(maxFuel, fuel + 30);
      magatamas.splice(i,1);
    } else if(m.y > canvas.height){
      magatamas.splice(i,1);
    }
  }

  // 燃料消費
  fuel -= fuelConsumption;
  if(fuel <= 0){ fuel=0; gameOver=true; }

  // 古墳追従
  kofun.x += (mouse.x-kofun.x)*0.1;
  kofun.y += (mouse.y-kofun.y)*0.1;
  kofun.x=Math.max(0,Math.min(canvas.width-kofun.size,kofun.x));
  kofun.y=Math.max(0,Math.min(canvas.height-kofun.size,kofun.y));

  ctx.drawImage(kofunImg,kofun.x,kofun.y,kofun.size,kofun.size);

  // --- エネルギーゲージ ---
  const fuelBarWidth = canvas.width * 0.6;
  const fuelBarHeight = 30;
  const fuelBarX = (canvas.width - fuelBarWidth)/2;
  const fuelBarY = 20;
  ctx.fillStyle = "purple";
  ctx.fillRect(fuelBarX, fuelBarY, (fuel/maxFuel)*fuelBarWidth, fuelBarHeight);
  ctx.strokeStyle = "black";
  ctx.lineWidth = 3;
  ctx.strokeRect(fuelBarX, fuelBarY, fuelBarWidth, fuelBarHeight);
  ctx.fillStyle = "black";
  ctx.font = "20px sans-serif";
  ctx.textAlign = "center";
  ctx.fillText("Magatama Energy", canvas.width/2, fuelBarY - 5);

  // --- スコア表示（エネルギーの下、左端） ---
  ctx.fillStyle = "black";
  ctx.font = `${Math.floor(canvas.width/20)}px sans-serif`;
  ctx.textAlign = "left";
  ctx.fillText("Score: " + score, 10, fuelBarY + fuelBarHeight + 40);

  if(gameOver){ onGameOver(); return; }

  loopId=requestAnimationFrame(gameLoop);
}

// --- ゲームオーバー ---
async function onGameOver(){
  cancelAnimationFrame(loopId);
  restartBtn.style.display="block";

  let todayRecord = await getTodayRecord();
  if(score>todayRecord){ await updateTodayRecord(score); todayRecord=score; }

  ctx.fillStyle="red"; ctx.font=`${Math.floor(canvas.width/20)}px sans-serif`; ctx.textAlign="center";
  ctx.fillText("GAME OVER",canvas.width/2,canvas.height/2);
  ctx.fillStyle="black"; ctx.font=`${Math.floor(canvas.width/30)}px sans-serif`;
  ctx.fillText("Your Score: "+score,canvas.width/2,canvas.height/2 + 50);
  ctx.fillText("Today's Record: "+todayRecord,canvas.width/2,canvas.height/2 + 90);
}

// --- リスタート ---
restartBtn.addEventListener("click",()=>{ restartBtn.style.display="none"; resetGame(); gameLoop(); });
function resetGame(){
  islands=[]; coins=[]; magatamas=[]; score=0; fuel=maxFuel; gameOver=false;
  kofun.x=canvas.width/2; kofun.y=canvas.height-tileSize*1.5;
}

gameLoop();
</script>
</body>
</html>



