<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>前方後円墳で来た。</title>
<style>
  body { margin:0; overflow:hidden; touch-action:none; background:#87ceeb; font-family:sans-serif; }
  canvas { display:block; margin:auto; background:#87ceeb; }
  #restartBtn {
    position:absolute; display:none; left:50%; top:60%; transform:translate(-50%,-50%);
    padding:10px 20px; font-size:20px; cursor:pointer;
  }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<button id="restartBtn">Restart</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

// --- Firebase設定 ---
const firebaseConfig = { /* 省略 */ };
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- 今日の世界記録 ---
function getTodayKey() { const now = new Date(); return `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`; }
async function getTodayRecord() { const snapshot = await get(ref(db, 'worldRecords/' + getTodayKey())); return snapshot.exists() ? snapshot.val() : 0; }
async function updateTodayRecord(score) { const key = getTodayKey(); const oldScore = await getTodayRecord(); if(score>oldScore){ await set(ref(db,'worldRecords/'+key),score); return true; } return false; }

// --- ゲーム用 ---
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const restartBtn = document.getElementById("restartBtn");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
let tileSize = Math.min(canvas.width/7, canvas.height/12);

// 画像
const seaImg=new Image(); seaImg.src="sea_tile.png";
const islandImg=new Image(); islandImg.src="island.png";
const kofunImg=new Image(); kofunImg.src="kofun.png";
const coinImg=new Image(); coinImg.src="coin.png";
const magatamaImg=new Image(); magatamaImg.src="magatama.png";

let seaTiles=[], offsetY=0, baseSpeed=16, scrollSpeed=baseSpeed*(tileSize/64);
for(let y=-1;y<=12;y++) for(let x=0;x<7;x++) seaTiles.push({x,y});

let kofun={x:canvas.width/2,y:canvas.height-tileSize*1.5,size:tileSize};
let mouse={x:kofun.x,y:kofun.y};
let islands=[], coins=[], magatamas=[], score=0, gameOver=false;
let maxFuel=100, fuel=maxFuel, fuelConsumption=0.1;

// 入力
canvas.addEventListener("mousemove", e=>{ mouse.x=e.offsetX - kofun.size/2; mouse.y=e.offsetY - kofun.size/2; });
canvas.addEventListener("touchmove", e=>{ mouse.x=e.touches[0].clientX - kofun.size/2; mouse.y=e.touches[0].clientY - kofun.size/2; });

// 島・コイン・勾玉
function spawnIsland(){ islands.push({x:Math.random()*(canvas.width-tileSize*2),y:-tileSize*2,size:tileSize*2}); }
setInterval(spawnIsland,2000);

function spawnCoin(){ 
  let coin, overlap;
  do{
    coin={x:Math.random()*(canvas.width-tileSize/2),y:-tileSize/2,size:tileSize/2};
    overlap=islands.some(island=>!(coin.x+coin.size<island.x||coin.x>island.x+island.size||coin.y+coin.size<island.y||coin.y>island.y+island.size));
  }while(overlap);
  coins.push(coin);
}
setInterval(spawnCoin,1500);

// 勾玉: 島と重ならない
function spawnMagatama(){
  let m, overlap;
  do {
    m = { x:Math.random()*(canvas.width-tileSize), y:-tileSize, size:tileSize };
    overlap = islands.some(island => !(m.x+m.size<island.x||m.x>island.x+island.size||m.y+m.size<island.y||m.y>island.y+island.size));
  } while(overlap);
  magatamas.push(m);
}
setInterval(spawnMagatama,4000);

// 衝突判定
function isColliding(a,b){ return !(a.x+a.size<b.x||a.x>b.x+b.size||a.y+a.size<b.y||a.y>b.y+b.size); }

// ゲームループ
let loopId;
function gameLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let t of seaTiles) ctx.drawImage(seaImg,t.x*tileSize,t.y*tileSize+offsetY,tileSize,tileSize);
  offsetY += scrollSpeed; if(offsetY>=tileSize) offsetY=0;

  // 島
  for(let i=islands.length-1;i>=0;i--){
    let island=islands[i];
    island.y+=scrollSpeed;
    ctx.drawImage(islandImg,island.x,island.y,island.size,island.size);
    const margin=0.6;
    const hitBox={x:island.x + island.size*(1-margin)/2, y:island.y + island.size*(1-margin)/2, size:island.size*margin};
    if(isColliding(kofun,hitBox)) gameOver=true;
    if(island.y>canvas.height) islands.splice(i,1);
  }

  // コイン
  for(let i=coins.length-1;i>=0;i--){
    let coin=coins[i]; coin.y+=scrollSpeed;
    ctx.drawImage(coinImg,coin.x,coin.y,coin.size,coin.size);
    if(isColliding(kofun,coin)){ score+=10; coins.splice(i,1); }
    else if(coin.y>canvas.height) coins.splice(i,1);
  }

  // 勾玉
  for(let i=magatamas.length-1;i>=0;i--){
    let m=magatamas[i]; m.y+=scrollSpeed;
    ctx.drawImage(magatamaImg,m.x,m.y,m.size,m.size);
    if(isColliding(kofun,m)){ fuel=Math.min(maxFuel,fuel+30); magatamas.splice(i,1); }
    else if(m.y>canvas.height) magatamas.splice(i,1);
  }

  fuel-=fuelConsumption;
  if(fuel<=0){ fuel=0; gameOver=true; }

  kofun.x += (mouse.x-kofun.x)*0.2;
  kofun.y += (mouse.y-kofun.y)*0.2;
  kofun.x=Math.max(0,Math.min(canvas.width-kofun.size,kofun.x));
  kofun.y=Math.max(0,Math.min(canvas.height-kofun.size,kofun.y));

  ctx.drawImage(kofunImg,kofun.x,kofun.y,kofun.size,kofun.size);

  // エネルギーゲージ
  const fuelBarWidth=canvas.width*0.6, fuelBarHeight=40, fuelBarX=(canvas.width-fuelBarWidth)/2, fuelBarY=20;
  ctx.fillStyle="purple"; ctx.fillRect(fuelBarX,fuelBarY,(fuel/maxFuel)*fuelBarWidth,fuelBarHeight);
  ctx.strokeStyle="black"; ctx.lineWidth=3; ctx.strokeRect(fuelBarX,fuelBarY,fuelBarWidth,fuelBarHeight);
  ctx.fillStyle="black"; ctx.font="28px sans-serif"; ctx.textAlign="center"; ctx.fillText("Magatama Energy",canvas.width/2,fuelBarY-8);

  // スコア
  ctx.fillStyle="black"; ctx.font="28px sans-serif"; ctx.textAlign="left"; ctx.fillText("Score: "+score,10,fuelBarY+fuelBarHeight+40);

  if(gameOver){ onGameOver(); return; }
  loopId=requestAnimationFrame(gameLoop);
}

// ゲームオーバー
async function onGameOver(){
  cancelAnimationFrame(loopId);
  restartBtn.style.display="block";
  let todayRecord=await getTodayRecord();
  if(score>todayRecord){ await updateTodayRecord(score); todayRecord=score; }

  const texts=["GAME OVER","Your Score: "+score,"Today's Record: "+todayRecord];
  ctx.font=`${Math.floor(canvas.width/20)}px sans-serif`;
  const widths=texts.map(t=>ctx.measureText(t).width);
  const textWidth=Math.max(...widths)+40;
  const textHeight=140;
  const overlayX=(canvas.width-textWidth)/2;
  const overlayY=(canvas.height-textHeight)/2;

  ctx.fillStyle="rgba(128,128,128,0.8)";
  ctx.fillRect(overlayX,overlayY,textWidth,textHeight);

  ctx.fillStyle="red"; ctx.textAlign="center";
  ctx.fillText(texts[0],canvas.width/2,overlayY+50);
  ctx.fillStyle="black"; ctx.font=`${Math.floor(canvas.width/30)}px sans-serif`;
  ctx.fillText(texts[1],canvas.width/2,overlayY+90);
  ctx.fillText(texts[2],canvas.width/2,overlayY+120);
}

// リスタート
restartBtn.addEventListener("click",()=>{ restartBtn.style.display="none"; resetGame(); gameLoop(); });
function resetGame(){ islands=[]; coins=[]; magatamas=[]; score=0; fuel=maxFuel; gameOver=false; kofun.x=canvas.width/2; kofun.y=canvas.height-tileSize*1.5; }

gameLoop();
</script>
</body>
</html>
