<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>古墳フライト</title>
<style>
  body { margin:0; overflow:hidden; touch-action:none; }
  canvas { display:block; margin:auto; background:#87ceeb; }
</style>
</head>
<body>
<canvas id="gameCanvas" width="400" height="600"></canvas>
<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

// 画像
const seaImg = new Image(); seaImg.src = "sea_tile.png";
const islandImg = new Image(); islandImg.src = "island.png";
const kofunImg = new Image(); kofunImg.src = "kofun.png";
const coinImg = new Image(); coinImg.src = "coin.png";

// スクロール
const tileSize = 64;
const scrollSpeed = 15;
let seaTiles = [];
for (let y=-tileSize; y<canvas.height+tileSize; y+=tileSize){
  for (let x=0; x<canvas.width; x+=tileSize){
    seaTiles.push({x,y});
  }
}

// プレイヤー
let kofun = { x: canvas.width/2-32, y: canvas.height-100, size:64 };
let mouse = { x:kofun.x, y:kofun.y };

// 島
let islands = [];
function spawnIsland() { islands.push({x:Math.random()*(canvas.width-128),y:-128,size:128}); }
setInterval(spawnIsland,2000);

// コイン
let coins = [];
function spawnCoin(){
  let coin, overlap;
  do{
    coin={x:Math.random()*(canvas.width-32),y:-32,size:32};
    overlap=islands.some(island=>!(coin.x+coin.size<island.x||coin.x>island.x+island.size||coin.y+coin.size<island.y||coin.y>island.y+island.size));
  }while(overlap);
  coins.push(coin);
}
setInterval(spawnCoin,1500);

// スコア
let score=0;
setInterval(()=>{score+=1},1000);

// 入力
canvas.addEventListener("mousemove", e=>{ mouse.x=e.offsetX-kofun.size/2; mouse.y=e.offsetY-kofun.size/2; });
canvas.addEventListener("touchmove", e=>{ mouse.x=e.touches[0].clientX-kofun.size/2; mouse.y=e.touches[0].clientY-kofun.size/2; });

// 矩形判定（四角）
function isColliding(a,b){ return !(a.x+a.size<b.x||a.x>b.x+b.size||a.y+a.size<b.y||a.y>b.y+b.size); }

// 古墳ピクセル判定用バッファ
let kofunBuffer=document.createElement("canvas");
kofunBuffer.width=kofun.size;
kofunBuffer.height=kofun.size;
let kctx=kofunBuffer.getContext("2d");
kctx.drawImage(kofunImg,0,0,kofun.size,kofun.size);
let kofunData=kctx.getImageData(0,0,kofun.size,kofun.size).data;

// 古墳ピクセル判定（敵は矩形でOKなので使用しない）
function pixelPerfectCollision(a,bImg,bX,bY){
  // aの不透明部分とbImgの矩形内にある部分だけ判定
  let xStart=Math.max(0,bX-a.x);
  let yStart=Math.max(0,bY-a.y);
  let xEnd=Math.min(a.size,bX-a.x+bImg.width);
  let yEnd=Math.min(a.size,bY-a.y+bImg.height);

  for(let y=yStart;y<yEnd;y++){
    for(let x=xStart;x<xEnd;x++){
      let aAlpha=kofunData[(y*a.size+x)*4+3];
      if(aAlpha>0) return true; // 古墳がbImg上に重なっているだけで判定
    }
  }
  return false;
}

let gameOver=false;

// 描画ループ
function gameLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // 海タイル
  for(let t of seaTiles){
    ctx.drawImage(seaImg,t.x,t.y,tileSize,tileSize);
    t.y+=scrollSpeed;
    if(t.y>=canvas.height) t.y=-tileSize+(t.y-canvas.height);
  }

  // 島
  for(let i=islands.length-1;i>=0;i--){
    let island=islands[i];
    island.y+=scrollSpeed;
    ctx.drawImage(islandImg,island.x,island.y,island.size,island.size);
    if(isColliding(kofun,island)) gameOver=true; // 島は矩形判定
    if(island.y>canvas.height) islands.splice(i,1);
  }

  // コイン
  for(let i=coins.length-1;i>=0;i--){
    let coin=coins[i];
    coin.y+=scrollSpeed;
    ctx.drawImage(coinImg,coin.x,coin.y,coin.size,coin.size);
    if(isColliding(kofun,coin)){ score+=10; coins.splice(i,1); } // コインは矩形判定
    else if(coin.y>canvas.height) coins.splice(i,1);
  }

  // 古墳ふわふわ追従
  kofun.x+=(mouse.x-kofun.x)*0.05;
  kofun.y+=(mouse.y-kofun.y)*0.05;

  // 画面外制限
  kofun.x=Math.max(0,Math.min(canvas.width-kofun.size,kofun.x));
  kofun.y=Math.max(0,Math.min(canvas.height-kofun.size,kofun.y));

  // 古墳描画
  ctx.drawImage(kofunImg,kofun.x,kofun.y,kofun.size,kofun.size);

  // スコア
  ctx.fillStyle="black";
  ctx.font="20px sans-serif";
  ctx.fillText("Score: "+score,10,30);

  // ゲームオーバー
  if(gameOver){
    ctx.fillStyle="red";
    ctx.font="40px sans-serif";
    ctx.fillText("GAME OVER",canvas.width/2-120,canvas.height/2);
    return;
  }

  requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
</body>
</html>
