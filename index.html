<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>前方後円墳で来た。</title>
<style>
  body { margin:0; overflow:hidden; touch-action:none; background:#87ceeb; font-family:sans-serif; }
  canvas { display:block; margin:auto; background:#87ceeb; }
  #restartBtn {
    position:absolute; display:none; left:50%; top:60%; transform:translate(-50%,-50%);
    padding:10px 20px; font-size:20px; cursor:pointer;
  }
  #loadingOverlay {
    position:absolute; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.7); color:white; display:flex;
    flex-direction:column; justify-content:center; align-items:center; font-size:24px;
    z-index:10;
  }
  #progressBar {
    width: 60%; height: 30px; background:#555; border-radius:8px; overflow:hidden; margin-top:20px;
  }
  #progress {
    width:0%; height:100%; background:limegreen;
  }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<button id="restartBtn">Restart</button>

<div id="loadingOverlay">
  <img id="loadingKofun" src="kofun.png" style="width:100px; margin-bottom:20px;">
  <div>Loading...</div>
  <div id="progressBar"><div id="progress"></div></div>
</div>

<div id="startOverlay" style="
    position:absolute; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.7); color:white; display:flex;
    flex-direction:column; justify-content:center; align-items:center; font-size:24px;
    z-index:10;
    display:none;
">
  <div style="margin-bottom:30px; text-align:center;">
    <p>前方後円墳を操作してコインを集めよう！</p>
    <p>マウス/タッチで移動</p>
    <p>勾玉を取ると燃料回復</p>
    <p>燃料がなくなるとゲームオーバー</p>
  </div>
  <button id="startBtn" style="font-size:28px; padding:10px 30px; cursor:pointer;">START</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

// Firebase設定
const firebaseConfig = {
  apiKey: "AIzaSyBMJWHa5H0COcPcFO5-SJV3jaIm1y9lggY",
  authDomain: "zenpo-ko-enfun.firebaseapp.com",
  databaseURL: "https://zenpo-ko-enfun-default-rtdb.firebaseio.com",
  projectId: "zenpo-ko-enfun",
  storageBucket: "zenpo-ko-enfun.appspot.com",
  messagingSenderId: "824547703470",
  appId: "1:824547703470:web:b9c36e1554a50de544cb3f",
  measurementId: "G-JWX8H2C58G"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- ゲーム準備 ---
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const restartBtn = document.getElementById("restartBtn");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
let tileSize = Math.min(canvas.width/7, canvas.height/12);

// 画像リスト
const images = {
  sea: "sea_tile.png",
  island: "island.png",
  kofun: "kofun.png",
  coin: "coin.png",
  magatama: "magatama.png"
};
const loadedImages = {};
const progressElem = document.getElementById("progress");
const loadingOverlay = document.getElementById("loadingOverlay");
const startOverlay = document.getElementById("startOverlay");
const startBtn = document.getElementById("startBtn");

// 画像読み込み
let loadedCount = 0;
for(const key in images){
  const img = new Image();
  img.src = images[key];
  img.onload = () => {
    loadedCount++;
    progressElem.style.width = (loadedCount/Object.keys(images).length*100) + "%";
    if(loadedCount === Object.keys(images).length){
      // ロード完了
      setTimeout(()=>{ // ちょっと待つと見栄えが良い
        loadingOverlay.style.display="none";
        startOverlay.style.display="flex";
      }, 300);
    }
  }
  loadedImages[key] = img;
}

// --- ゲーム変数 ---
let kofun = { x: canvas.width/2, y: canvas.height-tileSize*1.5, size: tileSize };
let mouse = { x:kofun.x, y:kofun.y };
let islands=[], coins=[], magatamas=[], score=0, gameOver=false;
let maxFuel = 70, fuel = maxFuel, fuelConsumption=0.1;

// 入力
canvas.addEventListener("mousemove", e=>{ mouse.x=e.offsetX - kofun.size/2; mouse.y=e.offsetY - kofun.size/2; });
canvas.addEventListener("touchmove", e=>{ mouse.x=e.touches[0].clientX - kofun.size/2; mouse.y=e.touches[0].clientY - kofun.size/2; });

// 衝突判定
function isColliding(a,b){ return !(a.x+a.size<b.x||a.x>b.x+b.size||a.y+a.size<b.y||a.y>b.y+b.size); }

// --- スポーン関数 ---
function spawnIsland(){ islands.push({x:Math.random()*(canvas.width-tileSize*2), y:-tileSize*2, size:tileSize*2}); }
function spawnCoin(){
  let coin, overlap;
  do{
    coin={x:Math.random()*(canvas.width-tileSize/2), y:-tileSize/2, size:tileSize/2};
    overlap=islands.some(island=>!(coin.x+coin.size<island.x||coin.x>island.x+island.size||coin.y+coin.size<island.y||coin.y>island.y+island.size));
  }while(overlap);
  coins.push(coin);
}
function spawnMagatama(){
  let m = { x: Math.random()*(canvas.width - tileSize*1), y: -tileSize*1, size: tileSize*1 };
  islands.forEach(island => {
    if (!(m.x + m.size < island.x || m.x > island.x + island.size || m.y + m.size < island.y || m.y > island.y + island.size)) {
      m.x = Math.min(canvas.width - m.size, island.x + island.size + 5);
    }
  });
  magatamas.push(m);
}

// --- ゲームループ ---
let loopId;
let offsetY=0, baseSpeed=16, scrollSpeed=baseSpeed*(tileSize/64);
function gameLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // 海
  for(let y=-1;y<=12;y++) for(let x=0;x<7;x++)
    ctx.drawImage(loadedImages.sea,x*tileSize,y*tileSize+offsetY,tileSize,tileSize);
  offsetY += scrollSpeed; if(offsetY>=tileSize) offsetY=0;

  // 島
  for(let i=islands.length-1;i>=0;i--){
    let island = islands[i];
    island.y += scrollSpeed;
    ctx.drawImage(loadedImages.island,island.x,island.y,island.size,island.size);
    const margin = 0.6;
    const hitBox = { x:island.x+island.size*(1-margin)/2, y:island.y+island.size*(1-margin)/2, size:island.size*margin };
    if(isColliding(kofun,hitBox)) gameOver=true;
    if(island.y>canvas.height) islands.splice(i,1);
  }

  // コイン
  for(let i=coins.length-1;i>=0;i--){
    let c=coins[i]; c.y+=scrollSpeed;
    ctx.drawImage(loadedImages.coin,c.x,c.y,c.size,c.size);
    if(isColliding(kofun,c)){ score+=10; coins.splice(i,1);}
    else if(c.y>canvas.height) coins.splice(i,1);
  }

  // 勾玉
  for(let i=magatamas.length-1;i>=0;i--){
    let m=magatamas[i]; m.y+=scrollSpeed;
    ctx.drawImage(loadedImages.magatama,m.x,m.y,m.size,m.size);
    if(isColliding(kofun,m)){ fuel=Math.min(maxFuel,fuel+30); magatamas.splice(i,1);}
    else if(m.y>canvas.height) magatamas.splice(i,1);
  }

  // 燃料消費
  fuel-=fuelConsumption;
  if(fuel<=0){ fuel=0; gameOver=true; }

  // 古墳追従
  kofun.x+=(mouse.x-kofun.x)*0.2; kofun.y+=(mouse.y-kofun.y)*0.2;
  kofun.x=Math.max(0,Math.min(canvas.width-kofun.size,kofun.x));
  kofun.y=Math.max(0,Math.min(canvas.height-kofun.size,kofun.y));
  ctx.drawImage(loadedImages.kofun,kofun.x,kofun.y,kofun.size,kofun.size);

  // 燃料ゲージ
  const fuelBarWidth = canvas.width*0.6, fuelBarHeight=40;
  const fuelBarX = (canvas.width-fuelBarWidth)/2, fuelBarY=20;
  ctx.fillStyle="purple"; ctx.fillRect(fuelBarX,fuelBarY,(fuel/maxFuel)*fuelBarWidth,fuelBarHeight);
  ctx.strokeStyle="black"; ctx.lineWidth=3; ctx.strokeRect(fuelBarX,fuelBarY,fuelBarWidth,fuelBarHeight);
  ctx.fillStyle="black"; ctx.font="28px sans-serif"; ctx.textAlign="center";
  ctx.fillText("Magatama Energy",canvas.width/2,fuelBarY-8);

  // スコア
  ctx.fillStyle="black"; ctx.font="28px sans-serif"; ctx.textAlign="left";
  ctx.fillText("Score: "+score,10,fuelBarY+fuelBarHeight+40);

  if(gameOver){ onGameOver(); return; }
  loopId=requestAnimationFrame(gameLoop);
}

// --- ゲームオーバー ---
async function onGameOver(){
  cancelAnimationFrame(loopId);
  restartBtn.style.display="block";
  clearInterval(islandInterval); clearInterval(coinInterval); clearInterval(magatamaInterval);
  // スコア表示などは省略
}

// --- リスタート ---
let islandInterval, coinInterval, magatamaInterval;
restartBtn.addEventListener("click",()=>{
  restartBtn.style.display="none"; resetGame();
  islandInterval = setInterval(spawnIsland, 1200); // 島スポーン早く
  coinInterval = setInterval(spawnCoin, 1500);
  magatamaInterval = setInterval(spawnMagatama, 4000);
  gameLoop();
});
function resetGame(){ islands=[]; coins=[]; magatamas=[]; score=0; fuel=maxFuel; gameOver=false;
  kofun.x=canvas.width/2; kofun.y=canvas.height-tileSize*1.5; }

// --- スタートボタン ---
let loopStarted=false;
startBtn.addEventListener("click",()=>{
  startOverlay.style.display="none";
  if(!loopStarted){
    loopStarted=true;
    islandInterval = setInterval(spawnIsland,1200); // 島早め
    coinInterval = setInterval(spawnCoin,1500);
    magatamaInterval = setInterval(spawnMagatama,4000);
    gameLoop();
  }
});
</script>
</body>
</html>
