<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>前方後円墳で来た。</title>
<style>
  body { margin:0; overflow:hidden; touch-action:none; background:#87ceeb; font-family:sans-serif; }
  canvas { display:block; margin:auto; background:#87ceeb; }
  #restartBtn {
    position:absolute; display:none; left:50%; top:60%; transform:translateX(-50%);
    padding:10px 20px; font-size:20px; cursor:pointer; z-index:10;
  }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<button id="restartBtn">Restart</button>

<!-- ロード画面 -->
<div id="loadOverlay" style="
    position:absolute; top:0; left:0; width:100%; height:100%;
    background:#000000cc; color:white; display:flex;
    flex-direction:column; justify-content:center; align-items:center; font-size:24px;
    z-index:10;
">
  <img id="loadKofun" src="kofun.png" style="width:100px; margin-bottom:20px;">
  <div style="width:300px; background:#555; height:30px; border-radius:15px; overflow:hidden;">
    <div id="loadBar" style="height:100%; width:0%; background:#0f0;"></div>
  </div>
  <p id="loadText">0%</p>
</div>

<!-- 操作説明オーバーレイ -->
<div id="startOverlay" style="
    position:absolute; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.7); color:white; display:none;
    flex-direction:column; justify-content:center; align-items:center; font-size:24px;
    z-index:10;
">
  <div style="margin-bottom:30px; text-align:center;">
    <p>前方後円墳を操作してコインを集めよう！</p>
    <p>マウス/タッチで移動</p>
    <p>勾玉を取ると燃料回復</p>
    <p>燃料がなくなるとゲームオーバー</p>
  </div>
  <button id="startBtn" style="font-size:28px; padding:10px 30px; cursor:pointer;">START</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

// --- Firebase設定 ---
const firebaseConfig = {
  apiKey: "AIzaSyBMJWHa5H0COcPcFO5-SJV3jaIm1y9lggY",
  authDomain: "zenpo-ko-enfun.firebaseapp.com",
  databaseURL: "https://zenpo-ko-enfun-default-rtdb.firebaseio.com",
  projectId: "zenpo-ko-enfun",
  storageBucket: "zenpo-ko-enfun.firebasestorage.app",
  messagingSenderId: "824547703470",
  appId: "1:824547703470:web:b9c36e1554a50de544cb3f",
  measurementId: "G-JWX8H2C58G"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- 今日の世界記録 ---
function getTodayKey() {
  const now = new Date();
  return `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
}
async function getTodayRecord() {
  const snapshot = await get(ref(db, 'worldRecords/' + getTodayKey()));
  return snapshot.exists() ? snapshot.val() : 0;
}
async function updateTodayRecord(score) {
  const key = getTodayKey();
  const oldScore = await getTodayRecord();
  if(score > oldScore){
    await set(ref(db, 'worldRecords/' + key), score);
    return true;
  }
  return false;
}

// --- ゲーム用 ---
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const restartBtn = document.getElementById("restartBtn");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
let tileSize = Math.min(canvas.width/7, canvas.height/12);

let seaImg = new Image(); seaImg.src = "sea_tile.png";
let islandImg = new Image(); islandImg.src = "island.png";
let kofunImg = new Image(); kofunImg.src = "kofun.png";
let coinImg = new Image(); coinImg.src = "coin.png";
let magatamaImg = new Image(); magatamaImg.src = "magatama.png";

let assets = [seaImg, islandImg, kofunImg, coinImg, magatamaImg];
let loadedCount = 0;

// --- ロード処理 ---
const loadOverlay = document.getElementById("loadOverlay");
const loadBar = document.getElementById("loadBar");
const loadText = document.getElementById("loadText");
assets.forEach(img=>{
  img.onload = ()=>{
    loadedCount++;
    let percent = Math.floor(loadedCount/assets.length*100);
    loadBar.style.width = percent+"%";
    loadText.textContent = percent+"%";
    if(loadedCount === assets.length){
      setTimeout(()=>{ loadOverlay.style.display="none"; startOverlay.style.display="flex"; }, 500);
    }
  }
});

// --- 初期化 ---
let seaTiles = [];
for(let y=-1;y<=12;y++) for(let x=0;x<7;x++) seaTiles.push({x,y});
let offsetY=0;
const baseSpeed=16;
const scrollSpeed = baseSpeed*(tileSize/64);

let kofun={ x:canvas.width/2, y:canvas.height-tileSize*1.5, size:tileSize };
let mouse={x:kofun.x, y:kofun.y};

let islands=[], coins=[], magatamas=[], score=0, gameOver=false;
let maxFuel=40, fuel=maxFuel, fuelConsumption=0.1;

// --- 入力 ---
canvas.addEventListener("mousemove", e=>{ mouse.x=e.offsetX - kofun.size/2; mouse.y=e.offsetY - kofun.size/2; });
canvas.addEventListener("touchmove", e=>{ mouse.x=e.touches[0].clientX - kofun.size/2; mouse.y=e.touches[0].clientY - kofun.size/2; });

// --- 衝突判定 ---
function isColliding(a,b){ return !(a.x+a.size<b.x||a.x>b.x+b.size||a.y+a.size<b.y||a.y>b.y+b.size); }

// --- 島・コイン・勾玉スポーン ---
function spawnIsland(){ islands.push({x:Math.random()*(canvas.width-tileSize*2), y:-tileSize*2, size:tileSize*2}); }
function spawnCoin(){
  let coin, overlap;
  do{
    coin={x:Math.random()*(canvas.width-tileSize/2), y:-tileSize/2, size:tileSize/2};
    overlap=islands.some(island=>!(coin.x+coin.size<island.x||coin.x>island.x+island.size||coin.y+coin.size<island.y||coin.y>island.y+island.size));
  }while(overlap);
  coins.push(coin);
}
function spawnMagatama(){
  let m = { x: Math.random()*(canvas.width - tileSize*1), y: -tileSize*1, size: tileSize*1 };
  islands.forEach(island => {
    if (!(m.x + m.size < island.x || m.x > island.x + island.size || m.y + m.size < island.y || m.y > island.y + island.size)) {
      m.x = Math.min(canvas.width - m.size, island.x + island.size + 5);
    }
  });
  magatamas.push(m);
}

// --- ゲームループ ---
let loopId;
function gameLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // 海
  for(let t of seaTiles) ctx.drawImage(seaImg,t.x*tileSize,t.y*tileSize+offsetY,tileSize,tileSize);
  offsetY += scrollSpeed; if(offsetY>=tileSize) offsetY=0;

  // 島
  for(let i=islands.length-1;i>=0;i--){
    let island = islands[i];
    island.y += scrollSpeed;
    ctx.drawImage(islandImg, island.x, island.y, island.size, island.size);
    const margin = 0.6;
    const hitBox = {x:island.x + island.size*(1-margin)/2, y:island.y + island.size*(1-margin)/2, size:island.size*margin};
    if(isColliding(kofun, hitBox)) gameOver = true;
    if(island.y > canvas.height) islands.splice(i,1);
  }

  // コイン
  for(let i=coins.length-1;i>=0;i--){
    let coin=coins[i];
    coin.y+=scrollSpeed;
    ctx.drawImage(coinImg,coin.x,coin.y,coin.size,coin.size);
    if(isColliding(kofun,coin)){ score+=10; coins.splice(i,1); }
    else if(coin.y>canvas.height) coins.splice(i,1);
  }

  // 勾玉
  for(let i=magatamas.length-1;i>=0;i--){
    let m = magatamas[i];
    m.y += scrollSpeed;
    ctx.drawImage(magatamaImg, m.x, m.y, m.size, m.size);
    if(isColliding(kofun, m)){ fuel=Math.min(maxFuel,fuel+30); magatamas.splice(i,1);}
    else if(m.y>canvas.height) magatamas.splice(i,1);
  }

  fuel -= fuelConsumption;
  if(fuel<=0){ fuel=0; gameOver=true; }

  // 古墳追従
  kofun.x += (mouse.x-kofun.x)*0.2; kofun.y += (mouse.y-kofun.y)*0.2;
  kofun.x=Math.max(0,Math.min(canvas.width-kofun.size,kofun.x));
  kofun.y=Math.max(0,Math.min(canvas.height-kofun.size,kofun.y));
  ctx.drawImage(kofunImg,kofun.x,kofun.y,kofun.size,kofun.size);

  // エネルギーゲージ
  const fuelBarWidth = canvas.width*0.6;
  const fuelBarHeight = 40;
  const fuelBarX = (canvas.width-fuelBarWidth)/2;
  const fuelBarY = 20;
  ctx.fillStyle = "purple";
  ctx.fillRect(fuelBarX,fuelBarY,(fuel/maxFuel)*fuelBarWidth,fuelBarHeight);
  ctx.strokeStyle = "black"; ctx.lineWidth=3;
  ctx.strokeRect(fuelBarX,fuelBarY,fuelBarWidth,fuelBarHeight);
  ctx.fillStyle="black"; ctx.font="28px sans-serif"; ctx.textAlign="center";
  ctx.fillText("Magatama Energy",canvas.width/2,fuelBarY-8);

  // スコア
  ctx.fillStyle="black"; ctx.font="28px sans-serif"; ctx.textAlign="left";
  ctx.fillText("Score: "+score,10,fuelBarY+fuelBarHeight+40);

  if(gameOver){ onGameOver(); return; }
  loopId=requestAnimationFrame(gameLoop);
}

// --- ゲームオーバー ---
async function onGameOver(){
  cancelAnimationFrame(loopId);
  restartBtn.style.display="block";
  clearInterval(islandInterval); clearInterval(coinInterval); clearInterval(magatamaInterval);

  let todayRecord = await getTodayRecord();
  if(score>todayRecord){ await updateTodayRecord(score); todayRecord=score; }

  ctx.fillStyle = "rgba(200,200,200,0.9)";
  ctx.fillRect(0, canvas.height/2 - 100, canvas.width, 200);

  ctx.fillStyle="red"; ctx.textAlign="center";
  ctx.font = `${Math.floor(canvas.width/20)}px sans-serif`;
  ctx.fillText("GAME OVER",canvas.width/2,canvas.height/2-20);

  ctx.fillStyle="black";
  ctx.font = `${Math.floor(canvas.width/30)}px sans-serif`;
  ctx.fillText("Your Score: "+score,canvas.width/2,canvas.height/2+20);
  ctx.fillText("Today's Record: "+todayRecord,canvas.width/2,canvas.height/2+60);
}

// --- リスタート ---
let islandInterval, coinInterval, magatamaInterval;
restartBtn.addEventListener("click",()=>{
  restartBtn.style.display="none";
  resetGame();
  islandInterval = setInterval(spawnIsland,1000);
  coinInterval = setInterval(spawnCoin,1000);
  magatamaInterval = setInterval(spawnMagatama,2500);
  gameLoop();
});

function resetGame(){
  islands=[]; coins=[]; magatamas=[]; score=0; fuel=maxFuel; gameOver=false;
  kofun.x=canvas.width/2; kofun.y=canvas.height-tileSize*1.5;
}

// --- スタートボタン処理 ---
const startOverlay = document.getElementById("startOverlay");
const startBtn = document.getElementById("startBtn");
let loopStarted=false;
startBtn.addEventListener("click",()=>{
  startOverlay.style.display="none";
  if(!loopStarted){
    loopStarted=true;
    islandInterval = setInterval(spawnIsland,1000);
    coinInterval = setInterval(spawnCoin,1000);
    magatamaInterval = setInterval(spawnMagatama,2500);
    gameLoop();
  }
});
</script>
</body>
</html>
